<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Scratch & Win</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:Segoe UI,Arial;
  background:#e8f9ff;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
}
.popup{
  background:#fff;
  width:90%;
  max-width:420px;
  padding:16px;
  border-radius:14px;
  text-align:center;
}
.scratch-area{
  position:relative;
  width:100%;
  height:200px;
  margin-top:16px;
  border-radius:12px;
  overflow:hidden;
  touch-action:none;
}
canvas{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
}
button{
  margin-top:16px;
  padding:12px;
  width:100%;
  border:none;
  border-radius:10px;
  background:#2b7a78;
  color:#fff;
  font-size:16px;
  display:none;
}
</style>
</head>

<body>

<div class="popup">
  <h2>Scratch & Win üéÅ</h2>
  <div class="scratch-area">
    <canvas id="prize"></canvas>
    <canvas id="scratch"></canvas>
  </div>
  <div id="msg" style="margin-top:12px;font-weight:700;display:none"></div>
  <button id="ok" onclick="close()">OK</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script>
const params = new URLSearchParams(location.search);
const enc = params.get("enc");

const prizeCanvas = document.getElementById("prize");
const scratchCanvas = document.getElementById("scratch");
const pCtx = prizeCanvas.getContext("2d");
const sCtx = scratchCanvas.getContext("2d");
const msg = document.getElementById("msg");
const ok = document.getElementById("ok");

let drawing = false;
let revealed = false;
let lastX = 0, lastY = 0;

function init(){
  const r = window.devicePixelRatio || 1;
  const w = scratchCanvas.clientWidth;
  const h = scratchCanvas.clientHeight;

  [prizeCanvas, scratchCanvas].forEach(c=>{
    c.width = w*r;
    c.height = h*r;
    c.getContext("2d").setTransform(r,0,0,r,0,0);
  });

  pCtx.fillStyle="#fff";
  pCtx.fillRect(0,0,w,h);

  sCtx.fillStyle="#b0b0b0";
  sCtx.fillRect(0,0,w,h);
  sCtx.globalCompositeOperation="destination-out";
}

function getPos(e){
  const r = scratchCanvas.getBoundingClientRect();
  return {
    x:(e.touches?e.touches[0].clientX:e.clientX)-r.left,
    y:(e.touches?e.touches[0].clientY:e.clientY)-r.top
  };
}

function start(e){
  e.preventDefault();
  drawing=true;
  const p=getPos(e);
  lastX=p.x; lastY=p.y;
}

function move(e){
  if(!drawing || revealed) return;
  e.preventDefault();
  const p=getPos(e);
  sCtx.lineWidth=26;
  sCtx.lineCap="round";
  sCtx.beginPath();
  sCtx.moveTo(lastX,lastY);
  sCtx.lineTo(p.x,p.y);
  sCtx.stroke();
  lastX=p.x; lastY=p.y;
}

async function end(){
  if(!drawing || revealed) return;
  drawing=false;
  revealed=true;

  const res = await fetch(
    "https://asia-south1-track-and-trace-native.cloudfunctions.net/saveCustomerClaim",
    {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({ enc })
    }
  );
  const data = await res.json();

  pCtx.fillStyle="#0b3a4a";
  pCtx.font="700 28px Segoe UI";
  pCtx.textAlign="center";
  pCtx.textBaseline="middle";
  pCtx.fillText(data.prize, prizeCanvas.width/2, prizeCanvas.height/2);

  scratchCanvas.style.opacity=0;
  msg.textContent="You won: "+data.prize;
  msg.style.display="block";
  ok.style.display="block";
  confetti();
}

scratchCanvas.addEventListener("mousedown",start);
scratchCanvas.addEventListener("mousemove",move);
document.addEventListener("mouseup",end);

scratchCanvas.addEventListener("touchstart",start,{passive:false});
scratchCanvas.addEventListener("touchmove",move,{passive:false});
scratchCanvas.addEventListener("touchend",end);

async function check(){
  const res = await fetch(
    `https://asia-south1-track-and-trace-native.cloudfunctions.net/checkClaim?enc=${enc}`
  );
  const data = await res.json();
  if(data.scratched){
    revealed=true;
    pCtx.fillStyle="#0b3a4a";
    pCtx.font="700 28px Segoe UI";
    pCtx.textAlign="center";
    pCtx.textBaseline="middle";
    pCtx.fillText(data.prize, prizeCanvas.width/2, prizeCanvas.height/2);
    scratchCanvas.style.display="none";
    msg.textContent="Already claimed: "+data.prize;
    msg.style.display="block";
    ok.style.display="block";
  }
}

function close(){}

init();
check();
</script>
</body>
</html>
